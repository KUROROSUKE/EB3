let p1_hand=[],p2_hand=[],p1_point=0,p2_point=0,p1_selected_card=[],p2_selected_card=[],dropped_cards_p1=[],dropped_cards_p2=[],time="game",p1_is_acting=!1;const card_num=8;let WIN_POINT=250,WIN_TURN=10,numTurn=1,turn="p1";const elementToNumber={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Fe:26,Cu:29,Zn:30,I:53},elements=[...Array(6).fill("H"),...[,,,,].fill("O"),...[,,,,].fill("C"),"He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"],element=["H","O","C","He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"];let MineTurn=null;async function initializeMaterials(){if(!await getItem("materials")){let e={};materials.forEach(t=>{e[t.a]=0}),await setItem("materials",e)}await getItem("sumNs")||await setItem("sumNs",0)}const DB_NAME="GameDB",STORE_NAME="GameStore";function openDB(){return new Promise((e,t)=>{let n=indexedDB.open("GameDB",1);n.onerror=e=>t("DB open error"),n.onsuccess=t=>e(t.target.result),n.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(STORE_NAME)||t.createObjectStore(STORE_NAME)}})}async function setItem(e,t){let n=await openDB(),l=n.transaction(STORE_NAME,"readwrite"),a=l.objectStore(STORE_NAME);return a.put(t,e),l.complete}async function getItem(e){let t=await openDB(),n=t.transaction(STORE_NAME,"readonly"),l=n.objectStore(STORE_NAME);return new Promise((t,n)=>{let a=l.get(e);a.onsuccess=()=>t(a.result),a.onerror=()=>n("Get error")})}let xs=[],ys=[],isTraining=!1,model,modelName,outputNum;const countTemplate=Object.fromEntries(Object.values(elementToNumber).map(e=>[e,0]));function extractModelName(e){let t=e.match(/\/([^\/]+)$/);return t?t[1]:null}async function loadModel(e=null,t=null){try{if(null==e){let n=await tf.io.listModels();modelName="standardModel2",n["indexeddb://standardModel2"]?(model=await tf.loadLayersModel("indexeddb://standardModel2"),console.log("ローカルの学習済みモデルをロードしました")):(model=await tf.loadLayersModel("https://kurorosuke.github.io/AI_models/model3/model.json"),console.log("サーバーからモデルをロードしました"),await saveModel())}else{let l=await tf.io.listModels();l[`indexeddb://${modelName=null==t?extractModelName(e):t}`]?(model=await tf.loadLayersModel(`indexeddb://${modelName}`),console.log("ローカルの学習済みモデルをロードしました")):(console.log(`${e}/model.json`),model=await tf.loadLayersModel(`${e}/model.json`),console.log("サーバーからモデルをロードしました")),await saveModel()}if(addOptions(),(outputNum=model.outputs[0].shape[1])!=materials.length){let a=document.getElementById("Attention4");a.innerHTML=`モデルは出力${outputNum}個に対応していますが、compoundsは${materials.length}個です`,a.style.display="inline"}else document.getElementById("Attention4").style.display="none";document.getElementById("Attention").style.display="none"}catch(i){console.error("モデルのロードに失敗しました",i),document.getElementById("Attention").style.display="block"}}function oneHotEncode(e,t){let n=Array(t).fill(0);return n[e]=1,n}async function convertToCount(e){let t={...countTemplate};return e.forEach(e=>{let n=elementToNumber[e];void 0!==n&&(t[n]+=1)}),Object.values(t)}async function addTrainingData(e,t,n){if(!model){console.log("モデルがロードされていません");return}console.log(`playerData: ${e}`);var l=await convertToCount(e),a=l.reduce(function(e,t){return e+t},0);l.push(n),l.push(2*a+Number(!n)+1),console.log(`InputData: ${l}`);let i=tf.tensor2d([l],[1,26]),o=tf.tensor2d([oneHotEncode(t,model.outputShape[1])],[1,model.outputShape[1]]);xs.push(i),ys.push(o),console.log("データを追加しました: クラス",t)}async function trainModel(){if(!model||0===xs.length){console.log("学習データが不足しています");return}if(isTraining)return;if(isTraining=!0,model.compile({optimizer:tf.train.adam(.002),loss:"categoricalCrossentropy",metrics:["accuracy"]}),!model.outputShape||model.outputShape.length<2){console.error("モデルの outputShape が不正です:",model.outputShape);return}let e=tf.concat(xs),t=tf.concat(ys);await model.fit(e,t,{epochs:2,batchSize:32,callbacks:{onEpochEnd(e,t){console.log(`Epoch ${e+1}: Loss = ${t.loss.toFixed(4)}, Accuracy = ${t.acc.toFixed(4)}`)}}}),console.log("手札に最も近い物質のデータを追加学習...");let n=[],l=[],a=model.outputShape[1]||(materials?materials.length:10);if(!a||isNaN(a)){console.error("numClasses が不正です:",a),isTraining=!1;return}if(xs.forEach((e,t)=>{let i=findClosestMaterials(p2_hand)[0];if(console.log(i),!i){console.warn(`手札 ${t} に対応する近い物質が見つかりません。スキップします。`);return}let o=i.index;console.log(o),console.log(`学習対象: 手札 ${t} → 近い物質: materials[${o}]`);let r=oneHotEncode(o,a);l.push(tf.tensor2d([r],[1,a])),n.push(e)}),0===n.length||0===l.length){console.warn("追加学習用のデータが不足しているため、スキップします。"),isTraining=!1;return}let i=tf.concat(n),o=tf.concat(l);model.compile({optimizer:tf.train.adam(.001),loss:"categoricalCrossentropy",metrics:["accuracy"]}),await model.fit(i,o,{epochs:1,batchSize:32,callbacks:{onEpochEnd(e,t){console.log(`Epoch ${e+1}: Loss = ${t.loss.toFixed(4)}, Accuracy = ${t.acc.toFixed(4)}`)}}}),console.log("モデルの追加学習が完了しました"),e.dispose(),t.dispose(),i.dispose(),o.dispose(),xs=[],ys=[],isTraining=!1,await saveModel()}async function runModel(e,t){if(!model){console.log("モデルがロードされていません");return}var n=await convertToCount(dropped_cards_p2),l=n.reduce(function(e,t){return e+t},0);n.push(e),n.push(2*l+Number(!e)+1),n=tf.tensor2d([n],[1,26]);let a=model.predict(n),i=await a.data(),o,r=await calculateWeightedProbabilities(calculatePseudoProbabilities(getUsedMaterials()),i),d=Object.entries(r).sort((e,t)=>t[1]-e[1]),s=d.slice(0,3),c=d.findIndex(([e])=>e==t)+1;s.push([t,r[t]]);let p=document.getElementById("predictTable").getElementsByTagName("tbody")[0];p.innerHTML="";let u=["1位","2位","3位",`${c}位`];s.forEach(([e,t],n)=>{if(null!=materials[e]){let l=p.insertRow(),a=l.insertCell(0),i=l.insertCell(1),o=l.insertCell(2);a.innerHTML=u[n],i.innerHTML=materials[e].a,o.innerHTML=(100*t).toFixed(2)+"%"}}),document.getElementById("predictResultContainer").style.display="inline";var y=Math.max(...Object.values(r)),m=Object.keys(r).find(e=>r[e]===y);console.log(`予測した化合物のキー：${m}`);try{for(;await CanCreateMaterial(materials[m]);){if(delete r[m],0===Object.keys(r).length){console.log("作成できる候補がありません");return}var y=Math.max(...Object.values(r)),m=Object.keys(r).find(e=>r[e]===y)}}catch{console.log(materials[m]),null==materials[m]&&console.log("モデルと化合物のバージョンが異なります")}m<=materials.length&&(console.log(`推論結果: クラス ${m}, 信頼度: ${y}`),document.getElementById("predictResult").innerHTML=`予測結果：${materials[m].a}・信頼度：${y}`)}async function saveModel(){if(!model){console.log("モデルがロードされていません");return}try{console.log(`indexeddb://${modelName}`),await model.save(`indexeddb://${modelName}`),console.log("学習済みモデルを IndexedDB に保存しました")}catch(e){console.error("モデルの保存に失敗しました",e)}}async function warmUpModel(){let e=tf.tensor2d([Array(26).fill(0)],[1,26]);model.predict(e),console.log("✅ モデルのウォームアップ完了")}async function getUsedMaterials(){let e=await getItem("materials");return e&&"{}"!==e?Object.fromEntries(Object.entries(e).filter(([e,t])=>t>0)):(console.log("No valid materials data found."),{})}function calculatePseudoProbabilities(e){let t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return{};let n={};for(let l in e)n[l]=e[l]/t;return n}async function calculateWeightedProbabilities(e,t){let n={};for(let l in t)e.hasOwnProperty(l)?(sumNs=await getItem("sumNs"),n[l]=(e[l]*sumNs/(sumNs+10)+t[l])/2):n[l]=t[l];return n}async function incrementMaterialCount(e){let t=await getItem("materials");t[e]=(materials[e]||0)+1,await setItem("materials",t),await setItem("sumNs",await getItem("sumNs")+1)}async function view_p1_hand(){let e=document.getElementById("p1_hand");p1_hand.forEach((t,n)=>{let l=imageCache[0],a=new Image;a.src=URL.createObjectURL(l),a.alt="相手の手札",a.style.padding="5px",a.style.border="1px solid #000",a.classList.add("selected"),a.classList.toggle("selected"),e.appendChild(a)})}async function p1_action(){if("p1"!==turn||p1_is_acting)return;p1_is_acting=!0;let e=materials.filter(e=>e.c>threshold),t=e.sort((e,t)=>{let n=Object.keys(e.d).reduce((t,n)=>t+Math.min(p1_hand.filter(e=>e===n).length,e.d[n]),0);return Object.keys(t.d).reduce((e,n)=>e+Math.min(p1_hand.filter(e=>e===n).length,t.d[n]),0)-n||t.c-e.c}),n=t[0];if(n){let l=!0;for(let a in n.d)if(!p1_hand.includes(a)||p1_hand.filter(e=>e===a).length<n.d[a]){l=!1;break}if(l&&n.c>threshold)time="make",await done("p1");else{let i=p1_hand.filter(e=>!(e in n.d)||p1_hand.filter(t=>t===e).length>n.d[e]);if(i.length>0){let o=i[Math.floor(Math.random()*i.length)];p1_exchange(p1_hand.indexOf(o))}else time="make",done("p1")}}else p1_exchange(Math.floor(Math.random()*p1_hand.length));turn="p2",p1_is_acting=!1}async function p1_exchange(e){console.log("this"),dropped_cards_p1.push(p1_hand[e]);var t=p1_hand[e];if(!p1_hand[e]){console.error("Invalid target element in p1_hand.");return}let n=imageCache[elementToNumber[p1_hand[e]]],l=new Image;l.src=URL.createObjectURL(n),l.style.border="1px solid #000",document.getElementById("dropped_area_p1").appendChild(l);let a=document.querySelectorAll("#p1_hand img")[e];if(!a){console.error("Image element not found in p1_hand.");return}let i=drawCard();p1_hand[e]=i,a.alt=i,a.style.border="1px solid #000",a.classList.remove("selected"),a.classList.add("selected"),a.classList.toggle("selected"),turn="p2",checkRon(t)}async function p1_make(e){let t=await search_materials(arrayToObj(p1_hand));return t&&0!==t.length?(t.sort((e,t)=>t.c-e.c),p1_selected_card=dictToArray(t[0].d),t):[{a:"なし",b:"なし",c:0,d:{},e:[]}]}function selectCardsForMaterial(e,t){let n=[],l=[...e];for(let[a,i]of(l[l.indexOf(p1_selected_card[0])]=null,console.log(l),Object.entries(t))){let o=i;for(let r=0;r<l.length&&o>0;r++)l[r]===a&&(n.push(a),l[r]=null,o--)}return n}async function showDown(){console.log(p1_selected_card);let e=document.getElementById("p1_hand");e.innerHTML="";let t=[...p1_selected_card];p1_hand.forEach((n,l)=>{let a=elementToNumber[n],i=imageCache[a],o=new Image;o.src=URL.createObjectURL(i),o.alt=n,o.style.padding="5px",o.style.border="1px solid #000";let r=t.indexOf(n);-1!==r&&(o.classList.add("selectedP1"),t.splice(r,1)),e.appendChild(o)})}async function view_p2_hand(){let e=document.getElementById("p2_hand");p2_hand.forEach((t,n)=>{let l=imageCache[elementToNumber[t]],a=new Image;a.src=URL.createObjectURL(l),a.alt=t,a.style.padding="5px",a.style.border="1px solid #000",a.classList.add("selected"),a.classList.toggle("selected"),a.addEventListener("click",function(){let e=document.getElementById("ron_button");if(e.style.display="none","make"==time&&(this.classList.toggle("selected"),this.classList.contains("selected")?p2_selected_card.push(this.alt):p2_selected_card.splice(p2_selected_card.indexOf(this.alt),1)),turn==MineTurn&&"game"==time){dropped_cards_p2.push(this.alt);let t=imageCache[elementToNumber[this.alt]],l=new Image;l.src=URL.createObjectURL(t),l.alt=this.alt,l.style.border="1px solid #000",document.getElementById("dropped_area_p2").appendChild(l),this.classList.remove("selected"),this.classList.add("selected"),this.classList.toggle("selected");let a=drawCard(),i=imageCache[elementToNumber[a]];if(this.src=URL.createObjectURL(i),this.alt=a,this.style.padding="5px",this.style.border="1px solid #000",p2_hand[n]=a,"CPU"==GameType){turn="p1","none"!=document.getElementById("hintContainer").style.display&&document.getElementById("hint_button").click();let o=l.alt;setTimeout(()=>{checkRon(o)},500)}else changeTurn(turn="p2"==turn?"p1":"p2"),shareAction(action="exchange",otherData=l.alt)}}),e.appendChild(a)})}async function p2_make(){time="make",document.getElementById("generate_button").style.display="none",document.getElementById("hintContainer").style.display="none",document.getElementById("hint_button").style.display="none";let e=document.getElementById("done_button");e.style.display="inline",e.replaceWith(e.cloneNode(!0));let t=document.getElementById("done_button");return new Promise(e=>{t.addEventListener("click",function(){document.getElementById("done_button").style.display="none";let t=search(arrayToObj(p2_selected_card));e(t),"P2P"==GameType&&finishSelect()})})}async function checkRon(e){if("CPU"==GameType){if("p2"==turn){let t=await search_materials(arrayToObj([...p2_hand,e])),n=t.filter(t=>t.d[e]);if(n.length>0){let l=document.getElementById("ron_button");l.style.display="inline",l.replaceWith(l.cloneNode(!0));let a=document.getElementById("ron_button");a.addEventListener("click",function(){a.style.display="none";let t=document.querySelectorAll("#dropped_area_p1 img"),n=t[t.length-1];n.classList.add("selected"),p2_selected_card=[e],time="make",done("p2",p2_ron=!0)})}}else if("p1"==turn){console.log("P1 ron check");let i=await search_materials(arrayToObj([...p1_hand,e])),o=[];if(i.length>0){let r=i.reduce((e,t)=>t.c>e.c?t:e);console.log(r),r.c>=1.2*threshold&&e in r.d&&(o=[r])}if(o.length>0){console.log("P1 ron button"),time="make";let d=document.getElementById("dropped_area_p2").children,s=d[d.length-1];s.classList.add("selectedP1"),done("p1",o,e,p1_ron=!0)}else p1_action()}}else{console.log("this");let c=await search_materials(arrayToObj([...p2_hand,e])),p=c.filter(t=>t.d[e]);if(p.length>0){let u=document.getElementById("ron_button");u.style.display="inline",u.replaceWith(u.cloneNode(!0));let y=document.getElementById("ron_button");y.addEventListener("click",function(){y.style.display="none",p2_selected_card=[e],p2_make();let t=document.getElementById("dropped_area_p1").children,n=t[t.length-1];n.style.border="2px solid red",shareAction(action="generate",otherData=MineTurn)})}}}document.getElementById("generate_button").addEventListener("click",function(){turn==MineTurn&&(document.getElementById("hintContainer").style.display="none",document.getElementById("hint_button").style.display="none",time="make",document.getElementById("ron_button").style.display="none","CPU"==GameType?done("p2"):(p2_make(),shareAction(action="generate",otherData=MineTurn)))});let base_point_bonus=!1;async function get_dora(){return element[Math.round(23*Math.random())]}async function done(e,t,n,l=!1,a=!1){console.log(t),document.getElementById("ron_button").style.display="none",document.getElementById("hint_button").style.display="none",document.getElementById("hintContainer").style.display="none";let i=await p2_make(),o=await runModel("p1"==e?0:1,i.f),r=l?t:await p1_make(o);console.log(r),p1_selected_card.push(...dictToArray(r[0].d)),p1_selected_card.splice(p1_selected_card.indexOf(n),1);let d=await get_dora();console.log(`ドラ: ${d}`);let s=i.c,c=r[0].c;Boolean(i.e.includes(r[0].b))?s*=1.5+Math.random()/2:Boolean(r[0].e.includes(i.b))&&(c*=1.5+Math.random()/2),Boolean(Object.keys(i.d).includes(d))?s*=1.5:Boolean(Object.keys(r[0].d).includes(d))&&(c*=1.5),(l||a)&&("p2"==e?s/=1.2:c/=1.2),"p2"==e?c/=1.5:s/=1.5,s=Math.round(s),base_point_bonus&&(s+=s),p1_point+=await (c=Math.round(c)),p2_point+=await s,document.getElementById("p2_point").innerHTML+=`+${s}`,document.getElementById("p1_point").innerHTML+=`+${c}`,document.getElementById("p2_explain").innerHTML=`生成物質：${i.a}, 組成式：${i.b}`,document.getElementById("p1_explain").innerHTML=`生成物質：${r[0].a}, 組成式：${r[0].b}`,IsTraining&&(await addTrainingData(p2_hand,i.f,"p1"==e?0:1),await trainModel(),await incrementMaterialCount(i.a));let p=await win_check(),u=document.getElementById("p1_explain");"p1"==p?(u.innerHTML="YOU LOSE",u.style.color="blue",u.style.fontSize="5vh"):"p2"==p&&(u.innerHTML="YOU WIN!",u.style.color="red",u.style.fontSize="5vh"),document.getElementById("done_button").style.display="none";let y=document.getElementById("nextButton");y.style.display="inline",showDown(),p?(console.log("ゲーム終了"),y.textContent="ラウンド終了",y.addEventListener("click",function(){returnToStartScreen(),p1_point=0,p2_point=0,numTurn=1,resetGame(),y.style.display="none";let e=y.cloneNode(!0);y.parentNode.replaceChild(e,y)})):(console.log("次のゲーム"),numTurn+=1,y.textContent="次のゲーム",y.addEventListener("click",function(){document.getElementById("predictResultContainer").style.display="none",resetGame(),y.style.display="none";let e=y.cloneNode(!0);y.parentNode.replaceChild(e,y)}))}async function win_check(){return Math.abs(p1_point-p2_point)>=WIN_POINT?p1_point>p2_point?"p1":"p2":numTurn>=WIN_TURN?p1_point>p2_point?"p1":"p2":null}function arrayToObj(e){let t={};return e.forEach(e=>{t[e]?t[e]++:t[e]=1}),t}function dictToArray(e){let t=[];for(let[n,l]of Object.entries(e))for(let a=0;a<l;a++)t.push(n);return t}function shuffle(e){let t=e.length;for(;0!=t;){let n=Math.floor(Math.random()*t);t--,[e[t],e[n]]=[e[n],e[t]]}return e}function drawCard(){return deck.length>0?deck.pop():(time="make","CPU"==GameType?done("no-draw"):no_draw_card())}function removeCards(e,t){let n=new Map;for(let l of t)n.set(l,(n.get(l)||0)+1);return e.filter(e=>!(n.has(e)&&n.get(e)>0)||(n.set(e,n.get(e)-1),!1))}async function CanCreateMaterial(e){if(!e)return console.error("❌ Error: Material is undefined!"),!0;let t=e.d,n={},l=[...p1_hand,...dropped_cards_p1,...dropped_cards_p2],a=[...elements,...elements];if((a=await removeCards(a,l)).forEach(e=>{n[e]=(n[e]||0)+1}),0==e.c)return console.log("Material has c == 0, returning true."),!0;for(let i in t)if(!n[i]||n[i]<t[i])return console.log(`Missing element: ${i}, returning true.`),!0;return!1}async function search_materials(e){return materials.filter(t=>{for(let n in t.d)if(!e[n]||t.d[n]>e[n])return!1;return!0})}async function search(e){return materials.find(t=>{for(let n in e)if(!t.d[n]||t.d[n]!==e[n])return!1;for(let l in t.d)if(!e[l])return!1;return!0})||materials[0]}let selectingModel,IsTraining,compoundsURL;async function saveWinSettings(){let e=parseInt(document.getElementById("winPointInput").value,10),t=parseInt(document.getElementById("winTurnInput").value,10),n=parseFloat(document.getElementById("threshold").value),l=document.getElementById("IsTraining").value,a=document.getElementById("compoundsSelection").value;if(compoundsURL="url"===a?document.getElementById("compoundsURL").value:`https://kurorosuke.github.io/compounds/${a}.json`,isNaN(e)){alert("コールドスコア は 1 以上 999 以下の数値を入力してください。");return}if(e<1){alert("コールドスコア は 1 以上の数値を入力してください。");return}if(e>999){if(20100524==e){alert("開発モード！ポイント２倍！"),base_point_bonus=!0;return}alert("コールドスコア の最大値は 999 です。");return}if(isNaN(t)||t<1){alert("ターン数 は 1 以上の数値を入力してください。");return}if(isNaN(n)||n<0){alert("相手しきい値 は 0以上の値にしてください。");return}threshold=n,WIN_POINT=e,WIN_TURN=t,IsTraining=l,materials=await loadMaterials(compoundsURL),closeWinSettings()}function closeWinSettings(){document.getElementById("winSettingsModal").style.display="none"}function showInputTag(){"url"==document.getElementById("compoundsSelection").value?document.getElementById("compoundsURL").style.display="inline":document.getElementById("compoundsURL").style.display="none"}document.getElementById("setting_icon").addEventListener("click",function(){document.getElementById("winSettingsModal").style.display="inline"});let removeTarget=[];async function getModelsDate(e){try{let t=await tf.io.listModels(),n=t[`indexeddb://${e}`];if(!n)return"N/A";return new Date(n.dateSaved).toLocaleString()}catch(l){return console.error(`Error fetching date for model ${e}:`,l),"N/A"}}async function getModelNames(){try{let e=await tf.io.listModels(),t=Object.keys(e).map(e=>e.replace("indexeddb://",""));return t}catch(n){return console.error("モデル名の取得に失敗しました",n),[]}}function showModelDetail(){addOptions(),document.getElementById("modelModals").style.display="inline",document.getElementById("buttonModal").style.display="inline",document.getElementById("overlay").style.display="inline"}async function addLoadingButton(){let e=document.getElementById("modelModals"),t=document.createElement("input");t.type="file",t.id="modelFileInput",t.style.display="none",t.accept=".zip";let n=document.createElement("label");n.setAttribute("for","modelFileInput"),n.innerText="モデルを読み込む",n.style.display="inline-block",n.style.padding="10px 0px",n.style.backgroundColor="#eee",n.style.border="1px solid #ccc",n.style.borderRadius="6px",n.style.cursor="pointer",n.style.textAlign="center",n.style.margin="0 0 20px 0",n.id="FileLoadLabel",t.addEventListener("change",async e=>{let n=Array.from(e.target.files),l,a;try{let i=n[0];if(!i||!i.name.endsWith(".zip")){alert("ZIPファイルを選択してください");return}let o=await JSZip.loadAsync(i),r=Object.keys(o.files),d=r.find(e=>e.endsWith(".json"));if(!d)throw Error("model.json ファイルが見つかりません");let s=r.filter(e=>e!==d),c=await o.files[d].async("string"),p=await Promise.all(s.map(async e=>{let t=await o.files[e].async("arraybuffer");return new File([t],e,{type:"application/octet-stream"})})),u=new File([c],d,{type:"application/json"}),y=await tf.io.browserFiles([u,...p]);console.log(y),l=await tf.loadLayersModel(y),console.log(l);let m=await getModelNames();do tmpModelName=prompt("使われていないモデルの名前を入力してください（半角英数のみ）");while(m.includes(tmpModelName));await l.save(`indexeddb://${a=tmpModelName}`),await addOptions(),selectModelOnSetting(a)}catch(g){console.error("モデルの読み込みに失敗しました:",g),alert("モデルの読み込みに失敗しました")}t.value=""}),e.appendChild(t),e.appendChild(n)}function addInputModelDiv(){let e=document.createElement("div");e.id="_inputDiv";let t=document.createElement("input");t.id="inputTag",t.placeholder="新しいモデルのURLを入力";let n=document.createElement("button");n.innerHTML="追加",n.id="inputButton",n.onclick=function(){let e=document.getElementById("inputTag");console.log(e.value),getModelNames().then(t=>{do null==(userInput=prompt("名前を入力してください:"))&&(userInput=extractModelName(url));while(t.includes(userInput));loadModel(e.value,userInput),e.value=""})},e.appendChild(t),e.appendChild(n),document.getElementById("modelModals").appendChild(e)}async function addOptions(){let e=await getModelNames(),t=document.getElementById("modelModals");t.innerHTML="",addInputModelDiv(),addLoadingButton(),e.forEach(e=>{let n=document.createElement("div");n.className="modelModal",n.id=e,n.text=e;let l=document.createElement("h3");l.textContent=e,n.appendChild(l);let a=document.createElement("p");getModelsDate(e).then(e=>{a.textContent=e||"未取得"});let i=document.createElement("button");i.textContent="選択",i.id=n.id,i.onclick=function(){selectModelOnSetting(this.id)};let o=document.createElement("button");o.textContent="削除",o.id=n.id,o.onclick=function(){removeModelOnSetting(this.id)};let r=document.createElement("button");r.textContent="保存",r.id=n.id,r.onclick=function(){downloadModel(this.id)},n.appendChild(l),n.appendChild(a),n.appendChild(i),n.appendChild(r),n.appendChild(o),n.id==modelName&&(n.style.background="pink"),t.appendChild(n)})}function selectModelOnSetting(e){selectingModel=e;let t=document.querySelectorAll("#modelModals div");t.forEach(e=>{e.style.background="white"}),document.getElementById(e).style.background="pink"}function removeModelOnSetting(e){console.log(e),removeTarget.push(e),document.getElementById(e).remove()}async function downloadModel(e){try{console.log(e);let t=await tf.loadLayersModel(`indexeddb://${e}`);await t.save(tf.io.withSaveHandler(async t=>{let n=new JSZip,l=`${e}.weights.bin`,a={modelTopology:t.modelTopology,weightsManifest:[{paths:[l],weights:t.weightSpecs}]};n.file(`${e}.json`,JSON.stringify(a)),n.file(l,new Blob([t.weightData]));let i=await n.generateAsync({type:"blob"}),o=document.createElement("a");o.href=URL.createObjectURL(i),o.download=`${e}.zip`,document.body.appendChild(o),o.click(),document.body.removeChild(o),console.log(`モデル ${e} を 保存しました`)}))}catch(n){console.error(`モデル ${e} の保存に失敗しました`,n)}}function applyModalSetting(){removeTarget.forEach(e=>{tf.io.removeModel(`indexeddb://${e}`)}),console.log(`this:${selectingModel}`),selectingModel&&(removeTarget.includes(selectingModel)?loadModel("https://kurorosuke.github.io/AI_models/model3"):loadModel("notNull",selectingModel)),closeModelModal()}function closeModelModal(){removeTarget=[],document.getElementById("modelModals").style.display="none",document.getElementById("buttonModal").style.display="none",document.getElementById("overlay").style.display="none"}function showRules(){closePeerModal(),closeWinSettings(),document.getElementById("rulesModal").style.display="block"}function closeRules(){document.getElementById("rulesModal").style.display="none"}function handleOutsideClick(e){let t=document.getElementById("rulesModal");e.target===t&&closeRules()}function closePeerModal(){document.getElementById("PeerModal").style.display="none",window.removeEventListener("click",handleOutsideClick_PeerModal),window.removeEventListener("touchstart",handleOutsideClick_PeerModal)}function handleOutsideClick_PeerModal(e){let t=document.getElementById("PeerModal");t.contains(e.target)||closePeerModal()}function convertToVector2(e,t){let n=Array(t.length).fill(0);return e.forEach(e=>{let l=t.indexOf(e);-1!==l&&n[l]++}),n}function convertToVector(e,t){return t.map(t=>e[t]||0)}function cosineSimilarity(e,t){let n=0,l=0,a=0;for(let i=0;i<e.length;i++)n+=e[i]*t[i],l+=e[i]**2,a+=t[i]**2;return l=Math.sqrt(l),a=Math.sqrt(a),l&&a?n/(l*a):0}function pseudoCosVec(e,t){let n=convertToVector(materials[e].d,element),l=convertToVector(materials[t].d,element);console.log(n,l);let a=cosineSimilarity(n,l);return a}function findClosestMaterials(e){let t=convertToVector2(e,element);return materials.map((e,n)=>{let l=Array(element.length).fill(0);for(let[a,i]of Object.entries(e.d)){let o=element.indexOf(a);-1!==o&&(l[o]=i)}return{index:n,similarity:cosineSimilarity(t,l)}}).sort((e,t)=>t.similarity-e.similarity).slice(0,3)}function findClosestMaterial(e){let t=null,n=0;return materials.forEach((l,a)=>{let i=cosineSimilarity(e,Object.values(l.d));i>n&&(n=i,t={index:a,similarity:i})}),t}async function findMostPointMaterial(){let e=await search_materials(arrayToObj(p2_hand));if(0===e.length)console.log("p2_hand 内で作成可能な物質はありません。");else{let t=e.reduce((e,t)=>t.c>e.c?t:e,e[0]);console.log(`p2_hand 内で最もポイントが高い物質: ${t.a} (ポイント: ${t.c})`)}}document.getElementById("closeRulesButton").addEventListener("click",closeRules),window.addEventListener("click",handleOutsideClick),window.addEventListener("touchstart",handleOutsideClick),document.getElementById("OnlineStartButton").addEventListener("click",function(){let e=document.getElementById("PeerModal");closeRules(),closeWinSettings(),e.style.display="inline",setTimeout(()=>{window.addEventListener("click",handleOutsideClick_PeerModal),window.addEventListener("touchstart",handleOutsideClick_PeerModal)},100)}),document.getElementById("hint_button").addEventListener("click",function(){let e=findClosestMaterials(p2_hand),t=document.getElementById("hintTable").getElementsByTagName("tbody")[0];if(t.innerHTML="",0===e.length){let n=t.insertRow().insertCell(0);n.colSpan=3,n.innerHTML="近い物質が見つかりません",n.style.textAlign="center";return}e.forEach(e=>{let n=materials[e.index],l=t.insertRow(),a=l.insertCell(0),i=l.insertCell(1),o=l.insertCell(2);a.innerHTML=n.a,i.innerHTML=n.b,o.innerHTML=n.c}),document.getElementById("hintContainer").style.display="inline"});let materials=[],imageCache={},GameType,JSZip;function random_hand(){for(let e=0;e<8;e++)p1_hand.push(drawCard()),p2_hand.push(drawCard())}async function init_json(){materials=await loadMaterials(compoundsURL="https://kurorosuke.github.io/compounds/obf_standard_min.json")}async function loadMaterials(e){try{let t=await fetch(e),n=await t.json(),l=model?model.outputs[0].shape[1]:108;if(!n.material||!Array.isArray(n.material))return document.getElementById("Attention2").style.display="inline",[];if(document.getElementById("Attention2").style.display="none",console.log(n.material.length),l!=n.material.length){let a=document.getElementById("Attention4");a.innerHTML=`モデルは出力${l}個に対応していますが、compoundsは${n.material.length}個です`,a.style.display="inline"}else document.getElementById("Attention4").style.display="none";return n.material}catch(i){return console.error("Error fetching compounds:",i),document.getElementById("Attention2").style.display="inline",[]}}async function preloadImages(){let e=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,29,30,53].map(async e=>{try{let t=`../images/${e}.webp`,n=await fetch(t),l=await n.blob();imageCache[e]=l}catch(a){console.error(`Image loading error: ${e}`,a)}});await Promise.all(e),console.log("✅ 全画像のプリロード完了")}async function preloadBackgroundImages(){let e=window.innerWidth<=730,t=e?"../images/start_screen_mobile.webp":"../images/start_screen_desktop.webp";try{let n=await fetch(t,{cache:"force-cache"}),l=await n.blob(),a=URL.createObjectURL(l),i=new Image;i.src=a,i.style.display="none",document.body.appendChild(i);let o=document.getElementById("startScreen");o.style.backgroundImage=`url('${a}')`,console.log("✅ 背景画像読み込み＆設定完了:",t)}catch(r){console.error("背景画像の読み込みに失敗",t,r)}}function resetGame(){p1_hand=[],p2_hand=[],dropped_cards_p1=[],dropped_cards_p2=[],p1_selected_card=[],p2_selected_card=[],time="game",document.getElementById("generate_button").style.display="inline","P2P"==GameType&&"p2"==MineTurn&&(turn=.5>=Math.random()?"p1":"p2",console.log(`random turn :: ${turn}`),changeTurn(turn)),p1_finish_select=!0,p2_finish_select=!0,document.getElementById("p1_point").innerHTML=`ポイント：${p1_point}`,document.getElementById("p2_point").innerHTML=`ポイント：${p2_point}`,document.getElementById("p2_explain").innerHTML="　",document.getElementById("predictResult").innerHTML="　";let e=document.getElementById("p1_explain");e.innerHTML="　",e.style.color="black",e.style.fontSize="16px",document.getElementById("done_button").style.display="none",document.getElementById("nextButton").style.display="none",deck=shuffle(deck=[...elements,...elements]);let t=document.getElementById("p1_hand"),n=document.getElementById("p2_hand");t.innerHTML="",n.innerHTML="";let l=document.getElementById("dropped_area_p1"),a=document.getElementById("dropped_area_p2");l.innerHTML="",a.innerHTML="",random_hand(),view_p1_hand(),view_p2_hand(),document.getElementById("hint_button").style.display="inline",turn!==MineTurn&&"CPU"==GameType&&setTimeout(()=>p1_action(),500)}function returnToStartScreen(){document.getElementById("startScreen").style.display="flex",document.getElementById("p1_area").style.display="none",document.getElementById("dropped_area_p1").style.display="none",document.getElementById("dropped_area_p2").style.display="none",document.getElementById("p2_area").style.display="none",document.getElementById("gameRuleButton").style.display="block",document.getElementById("predictResultContainer").style.display="none",document.getElementById("centerLine").style.display="none"}function startGame(){document.getElementById("startScreen").style.display="none",document.getElementById("p1_area").style.display="block",document.getElementById("dropped_area_p1").style.display="block",document.getElementById("dropped_area_p2").style.display="block",document.getElementById("p2_area").style.display="block",document.getElementById("gameRuleButton").style.display="none",resetGame()}document.addEventListener("DOMContentLoaded",async function(){await preloadBackgroundImages(),await preloadImages(),await loadModel(),await init_json(),await initializeMaterials(),addInputModelDiv(),addLoadingButton(),peerID=await generatePeerID(),(peer=new Peer(peerID)).on("open",e=>{console.log(e),document.getElementById("my-id").innerText=`自分のPeerID：${e}`,document.getElementById("PeerModal").style.display="none"}),peer.on("connection",e=>{conn=e,null===MineTurn&&(MineTurn="p2"),setupConnection()}),document.getElementById("loading").style.display="none",document.getElementById("startButton").style.display="inline",document.getElementById("OnlineStartButton").style.display="inline",JSZip=(await import("https://cdn.skypack.dev/jszip@3.10.0")).default}),document.getElementById("startButton").addEventListener("click",function(){document.getElementById("startScreen").style.display="none",document.getElementById("p1_area").style.display="block",document.getElementById("dropped_area_p1").style.display="block",document.getElementById("dropped_area_p2").style.display="block",document.getElementById("p2_area").style.display="block",document.getElementById("gameRuleButton").style.display="none",document.getElementById("predictResultContainer").style.display="none",document.getElementById("centerLine").style.display="block",MineTurn="p2",GameType="CPU",resetGame()});let is_ok_p1=!1,is_ok_p2=!1,p1_finish_select=!0,p2_finish_select=!0,p1_make_material={},peer,conn;async function no_draw_card(){let e=await p2_make();await new Promise(e=>{let t=setInterval(()=>{p1_finish_select||p2_finish_select||(clearInterval(t),e())},100)}),"p2"===MineTurn&&(console.log("done"),finish_done_select(p1_make_material,e,"no-draw",isRon=!1))}async function finish_done_select(e,t,n,l=!1){dora=await get_dora();let a=t.c,i=e.c;Boolean(t.e.includes(e.b))?a*=1.5+Math.random()/2:Boolean(e.e.includes(t.b))&&(i*=1.5+Math.random()/2),Boolean(Object.keys(t.d).includes(dora))?a*=1.5:Boolean(Object.keys(e.d).includes(dora))&&(i*=1.5),l&&("p2"==n?a/=1.2:i/=1.2),"p2"==n?i/=1.5:a/=1.5,a=Math.round(a),p1_point+=await (i=Math.round(i)),p2_point+=await a,console.log(i),console.log(a),document.getElementById("p2_point").innerHTML+=`+${a}`,document.getElementById("p1_point").innerHTML+=`+${i}`,document.getElementById("p2_explain").innerHTML=`生成物質：${t.a}, 組成式：${t.b}`,document.getElementById("p1_explain").innerHTML=`生成物質：${e.a}, 組成式：${e.b}`,sharePoints(),winnerAndChangeButton()}function waitUntilBothTrue(e,t,n=100){return new Promise(l=>{let a=setInterval(()=>{e()&&t()&&(clearInterval(a),l())},n)})}async function winnerAndChangeButton(){let e=await win_check();document.getElementById("done_button").style.display="none";let t=document.getElementById("nextButton");t.style.display="inline",e?(console.log("ラウンド終了"),t.textContent="ラウンド終了",t.addEventListener("click",function(){returnToStartScreen(),p1_point=0,p2_point=0,numTurn=0,resetGame(),t.style.display="none";let e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),conn.close()})):(console.log("次のゲーム"),t.textContent="次のゲーム",t.addEventListener("click",async function(){is_ok_p2=!0,nextIsOK(),t.style.display="none",console.log("OK"),await waitUntilBothTrue(()=>is_ok_p1,()=>is_ok_p2),is_ok_p1=!1,is_ok_p2=!1,numTurn+=1,resetGame();let e=t.cloneNode(!0);t.parentNode.replaceChild(e,t)}))}async function generatePeerID(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=e.charAt(Math.floor(Math.random()*e.length)),n=e.charAt(Math.floor(Math.random()*e.length)),l="",a=e+"-_";for(let i=0;i<4;i++)l+=a.charAt(Math.floor(Math.random()*a.length));return"EB3_"+t+l+n}function connectToPeer(){null===MineTurn&&(MineTurn="p1");let e=document.getElementById("remote-id").value;document.getElementById("PeerModal").style.display="none",conn=peer.connect(e),setupConnection()}function setupConnection(){conn.on("open",()=>{GameType="P2P","p1"===MineTurn&&conn.send({type:"role",value:"p2"}),document.getElementById("PeerModal").style.display="none",startGame(),shareVariable()}),conn.on("data",e=>{if(console.log(e),"role"===e.type&&null===MineTurn&&(MineTurn=e.value),"variables"===e.type&&(p1_hand=e.p1_hand,deck=e.deck,turn=e.turn,WIN_POINT=e.win_point,WIN_TURN=e.win_turn,loadMaterials(e.compounds_url).then(e=>{materials=e}),console.log(materials),MineTurn="p1"==e.PartnerTurn?"p2":"p1"),"shareVariables"==e.type&&(p1_hand=p2_hand),"turn"===e.type&&(turn=e.value,console.log(`turn ::  ${turn}`),turn!=MineTurn?document.getElementById("generate_button").style.display="none":search_materials(arrayToObj(p2_hand))&&(document.getElementById("generate_button").style.display="inline")),"action"===e.type){if("exchange"==e.action){console.log("this"),deck=e.deck,dropped_cards_p1.push(e.otherData);let t=imageCache[elementToNumber[e.otherData]],n=new Image;n.src=URL.createObjectURL(t),n.alt=e.otherData,n.style.border="1px solid #000",document.getElementById("dropped_area_p1").appendChild(n),checkRon(e.otherData)}else"generate"==e.action&&(console.log("generate this in get action of generate"),p2_make())}"selected"===e.type&&(p1_finish_select=!1,p1_make_material=e.otherData,p2_finish_select||(console.log("get p1 selected & do finish_done_select"),finish_done_select(p1_make_material,p2_make_material,"p1"))),"pointsData"===e.type&&(document.getElementById("p1_point").innerHTML+=`+${e.p1_point-p1_point}`,document.getElementById("p2_point").innerHTML+=`+${e.p2_point-p2_point}`,document.getElementById("p1_explain").innerHTML=e.p1_explain,document.getElementById("p2_explain").innerHTML=e.p2_explain,p1_point=e.p1_point,p2_point=e.p2_point,winnerAndChangeButton()),"nextIsOK"===e.type&&(is_ok_p1=!0),void 0!==e.p1_hand&&(p1_hand=e.p1_hand),void 0!==e.deck&&(deck=e.deck)})}function shareVariable(){conn&&conn.open&&("p1"===MineTurn?(console.log(turn),conn.send({type:"variables",p1_hand:p2_hand,deck:deck,turn:turn,PartnerTurn:MineTurn,win_point:WIN_POINT,win_turn:WIN_TURN,compounds_url:compoundsURL})):conn.send({type:"shareVariables",p1_hand:p2_hand}))}function shareAction(e,t){conn&&conn.open?conn.send({type:"action",action:e,otherData:t,deck:deck}):console.error("⚠️ 接続が開かれていません！ アクションを送信できません。")}function changeTurn(e){conn&&conn.open&&(conn.send({type:"turn",value:e}),turn!=MineTurn?document.getElementById("generate_button").style.display="none":search_materials(arrayToObj(p2_hand))&&(document.getElementById("generate_button").style.display="inline"))}async function finishSelect(){conn&&conn.open&&(p2_make_material=await search(arrayToObj(p2_selected_card)),conn.send({type:"selected",value:MineTurn,otherData:p2_make_material}),p2_finish_select=!1)}async function sharePoints(){conn&&conn.open&&(p1_explain_copy=document.getElementById("p2_explain").textContent,p2_explain_copy=document.getElementById("p1_explain").textContent,conn.send({type:"pointsData",p1_point:p2_point,p1_explain:p1_explain_copy,p2_point:p1_point,p2_explain:p2_explain_copy}))}async function nextIsOK(){conn&&conn.open&&conn.send({type:"nextIsOK",content:!0})}
